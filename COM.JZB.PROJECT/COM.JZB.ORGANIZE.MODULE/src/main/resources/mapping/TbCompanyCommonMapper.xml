<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper
        PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
        "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.jzb.org.dao.TbCompanyCommonMapper">

    <!-- 查询公海单位 不做条件-->
    <select id="queryCompanyCommon" resultType="java.util.Map">
        SELECT
        DISTINCT
            tcc.cid,
            tcc.uid,
            ( SELECT cname FROM tb_dept_user WHERE uid = tcc.uid LIMIT 1 ) sales,
            tcc.status,
            tcl.cname,
            tcl.manager,
            tcl.region,
            tdu.cname AS username,
            tdu.phone AS userphone,
            ( SELECT cname FROM tb_dept_user WHERE uid = tcp.dictvalue AND tcp.typeid = 't000000' limit 1 ) AS service,
            ( SELECT dictvalue FROM tb_company_property WHERE cid = tcc.cid AND typeid = 't111111' limit 1 ) AS companyLevel,
            tcl.authid
        FROM
            tb_company_common tcc
            INNER JOIN tb_company_list tcl ON tcl.cid = tcc.cid
            LEFT JOIN tb_dept_user tdu ON tdu.cid = tcc.cid
            AND tdu.uid = tcl.manager
            LEFT JOIN tb_company_property tcp ON tcp.cid = tcc.cid
        WHERE
            tcc.status = '2'
            and tcc.uid=#{uid}
    </select>


    <!-- 查询单位名称 -->
    <select id="queryCompanyNameByID" parameterType="java.util.Map" resultType="java.lang.String">
        select cname from tb_company_list where cid=#{cid} and status='1'
    </select>

    <!-- 查询已分配的业主  带条件 -->
    <select id="queryCompanyCommonByKeyWord" parameterType="java.util.Map" resultType="java.util.Map">
        select * from (
        SELECT
        DISTINCT
        tcc.cid,
        tcc.uid,
        (select cname from tb_dept_user where uid=tcc.uid limit 1) sales,
        tcc.status,
        tcl.cname,
        tcl.manager,
        tcl.region,
        tdu.cname username,
        tdu.phone userphone,
        ( SELECT cname FROM tb_dept_user WHERE uid = tcp.dictvalue AND tcp.typeid = 't000000' limit 1 ) service,
        ( SELECT dictvalue FROM tb_company_property WHERE cid = tcc.cid AND typeid = 't111111' limit 1) companyLevel,
        tcl.authid
        FROM
        tb_company_common tcc
        INNER JOIN tb_company_list tcl ON tcl.cid = tcc.cid
        LEFT JOIN tb_dept_user tdu ON tdu.cid = tcc.cid
        AND tdu.uid = tcl.manager
        LEFT JOIN tb_company_property tcp ON tcp.cid = tcc.cid
        LEFT JOIN tb_company_info tci ON tcl.cid = tci.cid
        WHERE
        tcc.status = '2'
        ) a where 1=1

        <if test="uid!=null and uid !=''">
            and a.uid=#{uid}
        </if>
        <if test="region!=null and region !=''">
            and a.region=#{region}
        </if>
        <if test="companyLevel!=null and companyLevel !='' and companyLevel!='全部'">
            and a.companyLevel=#{companyLevel}
        </if>
        <if test="keyword!=null and keyword !=''">
            and (a.cname ~ #{keyword} or a.sales ~ #{keyword})
        </if>
    </select>


    <!-- 修改单位信息 -->
    <update id="updateCompany" parameterType="java.util.Map">
        update tb_company_list set cname=#{cname} ,region=#{region} where cid=#{cid}
    </update>


    <!--所有业主-业主列表查询出来的总数-->
    <select id="getCount" parameterType="java.util.Map" resultType="int">
        select
        count(1)
        from
        (
        select * from (
        SELECT
        DISTINCT
        tcc.cid,
        tcc.uid,
        (select cname from tb_dept_user where uid=tcc.uid limit 1) sales,
        tcc.status,
        tcl.cname,
        tcl.manager,
        tcl.region,
        tdu.cname username,
        tdu.phone userphone,
        ( SELECT dictvalue FROM tb_company_property WHERE cid = tcc.cid AND typeid = 't111111' limit 1) dictvalue,
        tcl.authid,
        tcl.logo,
        tcl.relmail,
        tci.address
        FROM
        tb_company_common tcc
        INNER JOIN tb_company_list tcl ON tcl.cid = tcc.cid
        LEFT JOIN tb_dept_user tdu ON tdu.cid = tcc.cid
        AND tdu.uid = tcl.manager
        LEFT JOIN tb_company_property tcp ON tcp.cid = tcc.cid
        LEFT JOIN tb_company_info tci ON tcl.cid = tci.cid
        WHERE
        tcc.status != '4'
        ) a where 1=1
        <if test="status != null and status != ''">
            and a.status = #{status}
        </if>
        <if test="region!=null and region !=''">
            and a.region=#{region}
        </if>
        <if test="dictvalue != null and dictvalue !='' and dictvalue !='全部'">
            and a.dictvalue=#{dictvalue}
        </if>
        <if test="keyword!=null and keyword !=''">
            and (a.cname ~ #{keyword} or a.sales ~ #{keyword})
        </if>
        <if test="province != null and province != ''">
            and a.region IN
            <foreach separator="," close=")" open="(" index="index" item="item" collection="list">
                #{item.region}
            </foreach>
        </if>
        ) as num
    </select>


    <update id="updateCompanyCommon" parameterType="java.util.Map">
        update
        tb_company_list
        set
        <if test="cname != null and cname != ''">cname=#{cname},</if>
        <if test="region != null and region != ''">region=#{region},</if>
        <if test="relperson != null and relperson != ''">relperson=#{relperson},</if>
        <if test="relphone != null and relphone != ''">relphone=#{relphone},</if>
        <if test="updtime != null and updtime != ''">updtime=#{updtime}</if>
        where
        cid = #{cid}
    </update>

    <!--所有业主-业主列表-删除-->
    <update id="deleteCompanyCommon" parameterType="java.util.List">
        <foreach collection="list" item="item" separator=";">
            update
            tb_company_common
            set
            <if test="item.status != null and item.status != ''">status=#{item.status}</if>
            where
            cid = #{item.cid}
        </foreach>
    </update>

    <!--分配业务员-->
    <update id="updateCompanys" parameterType="java.util.Map">
        update
        tb_company_common
        set
        <if test="status != null and status != ''">
            status = #{status},
        </if>
        <if test="uid != null and uid != ''">
            uid = #{uid}
        </if>
        where
        cid = #{cid}
    </update>


    <!-- 所有业主-业主列表查询 -->
    <select id="getCompanyCommoms" parameterType="java.util.Map" resultType="java.util.Map">
        select * from (
        SELECT
        DISTINCT
        tcc.cid,
        tcc.uid,
        (select cname from tb_dept_user where uid=tcc.uid limit 1) sales,
        tcc.status,
        tcl.cname,
        tcl.manager,
        tcl.region,
        tdu.cname username,
        tdu.phone userphone,
        ( SELECT dictvalue FROM tb_company_property WHERE cid = tcc.cid AND typeid = 't111111' limit 1) dictvalue,
        tcl.authid,
        tcl.logo,
        tcl.relmail,
        tci.address
        FROM
        tb_company_common tcc
        INNER JOIN tb_company_list tcl ON tcl.cid = tcc.cid
        LEFT JOIN tb_dept_user tdu ON tdu.cid = tcc.cid
        AND tdu.uid = tcl.manager
        LEFT JOIN tb_company_property tcp ON tcp.cid = tcc.cid
        LEFT JOIN tb_company_info tci ON tcl.cid = tci.cid
        WHERE
        tcc.status != '4'
        ) a where 1=1
        <if test="status != null and status != ''">
            and a.status = #{status}
        </if>
        <if test="region!=null and region !=''">
            and a.region=#{region}
        </if>
        <if test="dictvalue != null and dictvalue !='' and dictvalue !='全部'">
            and a.dictvalue=#{dictvalue}
        </if>
        <if test="keyword!=null and keyword !=''">
            and (a.cname ~ #{keyword} or a.sales ~ #{keyword})
        </if>
        <if test="province != null and province != ''">
            and a.region IN
            <foreach separator="," close=")" open="(" index="index" item="item" collection="list">
                #{item.region}
            </foreach>
        </if>
        limit
        #{pagesize}
        offset
        #{pageno}
    </select>

    <!-- 修改企业list表和info表信息 -->
    <update id="updateCompanyListInfo" parameterType="java.util.Map">
        update
        tb_company_list
        set
        <if test="cname != null and cname != ''">cname=#{cname},</if>
        <if test="region != null and region != ''">region=#{region},</if>
        <if test="manager != null and manager != ''">manager=#{uid},</if>
        <if test="logo != null and logo != ''">logo=#{logo},</if>
        <if test="uscc != null and uscc != ''">uscc=#{uscc},</if>
        <if test="photo != null and photo != ''">photo=#{photo},</if>
        <if test="authid != null and authid != ''">authid=${authid},</if>
        <if test="summary != null and summary != ''">summary=#{summary},</if>
        updtime=#{updtime}
        where
        cid = #{cid};
        update
        tb_company_info
        set
        <if test="curl != null and curl != ''">curl=#{curl},</if>
        <if test="fax != null and fax != ''">fax=#{fax},</if>
        <if test="limitday != null and limitday != ''">limitday=${limitday},</if>
        <if test="address != null and address != ''">address=#{address},</if>
        <if test="range != null and range != ''">range=#{range},</if>
        <if test="ctype != null and ctype != ''">ctype=#{ctype},</if>
        <if test="legaler != null and legaler != ''">legaler=#{legaler},</if>
        <if test="cardid != null and cardid != ''">cardid=#{cardid},</if>
        <if test="capital != null and capital != ''">capital=#{capital},</if>
        <if test="birthday != null and birthday != ''">birthday=${birthday},</if>
        <if test="content != null and content != ''">content=#{content},</if>
        <if test="license != null and license != ''">license=#{license},</if>
        <if test="idcardup != null and idcardup != ''">idcardup=#{idcardup},</if>
        <if test="idecarddown != null and idecarddown != ''">idecarddown=#{idecarddown},</if>
        <if test="authorg != null and authorg != ''">authorg=#{authorg},</if>
        updtime=#{updtime}
        where
        cid = #{cid};
    </update>
</mapper>