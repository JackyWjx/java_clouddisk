<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper
        PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
        "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.jzb.org.dao.CompanyUserMapper">
    <!--获取单位总数-->
    <select id="queryCompanyListCount" parameterType="java.util.Map" resultType="java.lang.Integer">
        SELECT
        count(1)
        FROM tb_company_list cl
        LEFT JOIN tb_dept_user du ON du.cid = cl.cid
        AND du.uid = cl.manager
        LEFT join tb_company_sysconfig cs on cs.cid = cl.cid
        left join tb_company_info ci on ci.cid = cl.cid
        where
        cl.status = #{status}
        <if test="authid == 0 and authid != ''">and cl.authid = ${authid}</if>
        <if test="authid == 1 and authid != ''">and cl.authid > ${authid}</if>
        <if test="cname != null and cname != ''">
            and (cl.cname LIKE CONCAT( '%',#{cname},'%') or du.cname LIKE CONCAT( '%',#{cname},'%'))
        </if>
    </select>

    <!--查询所有的企业列表-->
    <select id="queryCompanyList" parameterType="java.util.Map" resultType="java.util.Map">
        SELECT DISTINCT
        aaa.*
        FROM
        (
        SELECT
        cl.id,
        cl.cid,
        cl.cname,
        cl.region,
        du.cname AS uname,
        du.phone,
        cs.systemname,
        ci.address,
        to_char(to_timestamp(cl.regtime / 1000), 'yyyy-MM-dd') as jointime,
        cl.authid,
        COALESCE ( au.ispc, 2 ) AS ispc,
        COALESCE ( au.isapp, 2 ) AS isapp
        FROM tb_company_list cl
        LEFT JOIN tb_dept_user du ON du.cid = cl.cid
        AND du.uid = cl.manager
        LEFT join tb_company_sysconfig cs on cs.cid = cl.cid
        left join tb_company_info ci on ci.cid = cl.cid
        LEFT JOIN (
        SELECT
        prod.cid,
        MIN ( prod.ispc ) AS ispc,
        MIN ( prod.isapp ) AS isapp
        FROM
        (
        SELECT
        sq.cid,
        CASE
        sq.apptype
        WHEN 1 THEN
        1 ELSE 2
        END AS ispc,
        CASE
        sq.apptype
        WHEN 2 THEN
        1 ELSE 2
        END AS isapp
        FROM
        ( SELECT DISTINCT cid, apptype FROM tb_product_list WHERE status = '1' ) sq
        ) prod
        GROUP BY
        prod.cid
        ) au ON au.cid = cl.cid
        where
        cl.status = #{status}
        <if test="authid == 0 and authid != ''and authid != null">and cl.authid = ${authid}</if>
        <if test="authid == 1 and authid != ''and authid != null">and cl.authid > ${authid}</if>
        <if test="cname != null and cname != ''and cname != null">
            and (cl.cname LIKE CONCAT( '%',#{cname},'%') or du.cname LIKE CONCAT( '%',#{cname},'%'))
        </if>
        ) aaa
        order by aaa.id desc
        limit
        #{pagesize}
        offset
        #{pageno}
    </select>

    <!--查询所有的企业列表-->
    <select id="queryAppType" parameterType="java.util.Map" resultType="java.util.Map">
        SELECT
        distinct
        apptype
        FROM
        tb_product_list
        where
        cid = #{cid}
        and
        status = #{status}
    </select>

    <!--点击调入公海是加入公海单位表-->
    <insert id="insertCompanyCommon" parameterType="java.util.Map">
        INSERT INTO
        tb_company_common (cid, idx, ouid, addtime, updtime, status, summary)
        VALUES
        (
        #{cid},
        (select count(1)+1 from tb_company_common),
        #{uid},
        #{addtime},
        #{updtime},
        #{status}
        <choose>
            <when test="summary != null and summary != ''">
                ,#{summary}
            </when>
            <otherwise>
                ,null
            </otherwise>
        </choose>
        )
    </insert>

    <!--获取单位总数-->
    <select id="queryCommonListCount" parameterType="java.util.Map" resultType="java.lang.Integer">
        SELECT
        count(1)
        FROM
        tb_company_common cc
        LEFT JOIN
        tb_company_list cl on cc.cid = cl.cid
        LEFT JOIN
        tb_dept_user du
        ON du.cid = cl.cid
        AND du.uid = cl.manager
        left join
        tb_company_info ci on ci.cid = cl.cid
        where
        cc.status = #{status}
        <if test="region != null and region != ''">and cl.region = #{region}</if>
        <if test="cname != null and cname != ''">
            and (cl.cname LIKE CONCAT( '%',#{cname},'%') or du.cname LIKE CONCAT( '%',#{cname},'%'))
        </if>
    </select>

    <!--查询所有的企业列表-->
    <select id="queryCompanyCommonList" parameterType="java.util.Map" resultType="java.util.Map">
        SELECT
        cl.cid,
        cl.cname,
        cl.region,
        du.cname AS uname,
        du.phone,
        ci.address,
        cl.authid
        FROM
        tb_company_common cc
        LEFT JOIN
        tb_company_list cl on cc.cid = cl.cid
        LEFT JOIN
        tb_dept_user du
        ON du.cid = cl.cid
        AND du.uid = cl.manager
        left join
        tb_company_info ci on ci.cid = cl.cid
        where
        cc.status = #{status}
        <if test="region != null and region != ''">and cl.region = #{region}</if>
        <if test="cname != null and cname != ''">
            and (cl.cname LIKE CONCAT( '%',#{cname},'%') or du.cname LIKE CONCAT( '%',#{cname},'%'))
        </if>
        order by cc.id desc
        limit
        #{pagesize}
        offset
        #{pageno}
    </select>
</mapper>
