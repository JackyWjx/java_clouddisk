<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper
        PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
        "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.jzb.org.dao.CompanyUserMapper">
    <!--获取单位总数-->
    <select id="queryCompanyListCount" parameterType="java.util.Map" resultType="java.lang.Integer">
        SELECT
        count(1)
        FROM tb_company_list cl
        LEFT JOIN tb_dept_user du ON du.cid = cl.cid
        AND du.uid = cl.manager
        LEFT join tb_company_sysconfig cs on cs.cid = cl.cid
        left join tb_company_info ci on ci.cid = cl.cid
        where
        cl.status = #{status}
        <if test="authid == 0 and authid != ''">and cl.authid = ${authid}</if>
        <if test="authid == 1 and authid != ''">and cl.authid > ${authid}</if>
        <if test="cname != null and cname != ''">
            and (cl.cname LIKE CONCAT( '%',#{cname},'%') or du.cname LIKE CONCAT( '%',#{cname},'%'))
        </if>
    </select>

    <!--查询所有的企业列表-->
    <select id="queryCompanyList" parameterType="java.util.Map" resultType="java.util.Map">
        SELECT
        cl.cid,
        cl.cname,
        cl.region,
        du.cname                                               AS uname,
        du.phone,
        cs.systemname,
        ci.address,
        to_char(to_timestamp(cl.regtime / 1000), 'yyyy-MM-dd') as jointime,
        cl.authid
        FROM tb_company_list cl
        LEFT JOIN tb_dept_user du ON du.cid = cl.cid
        AND du.uid = cl.manager
        LEFT join tb_company_sysconfig cs on cs.cid = cl.cid
        left join tb_company_info ci on ci.cid = cl.cid
        where
        cl.status = #{status}
        <if test="authid == 0 and authid != ''">and cl.authid = ${authid}</if>
        <if test="authid == 1 and authid != ''">and cl.authid > ${authid}</if>
        <if test="cname != null and cname != ''">
        and (cl.cname LIKE CONCAT( '%',#{cname},'%') or du.cname LIKE CONCAT( '%',#{cname},'%'))
        </if>
        order by  cl.id
        limit
        #{pagesize}
        offset
        #{pageno}
    </select>

    <!--点击调入公海是加入公海单位表-->
    <insert id="insertCompanyCommon" parameterType="java.util.Map">
        INSERT INTO
        tb_company_common (cid, idx, ouid, addtime, updtime, status, summary)
        VALUES
        (
        #{cid},
        (select count(1)+1 from tb_company_common),
        #{uid},
        #{addtime},
        #{updtime},
        #{status}
        <choose>
            <when test="summary != null and summary != ''">
                ,#{summary}
            </when>
            <otherwise>
                ,null
            </otherwise>
        </choose>
        )
    </insert>
</mapper>
